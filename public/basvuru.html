<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav BaÅŸvuru Formu</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f3f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h2 { color: #d32f2f; text-align: center; margin-bottom: 20px; }
        
        /* SÄ±nav Ã–zeti Kutusu */
        .exam-summary { background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #d32f2f; }
        .exam-summary h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .exam-summary p { margin: 0; color: #555; font-size: 0.9rem; }

        /* Form ElemanlarÄ± */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        textarea { resize: vertical; height: 80px; }
        
        button { width: 100%; background: #d32f2f; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #b71c1c; }
        .back-link { display: block; text-align: center; margin-top: 15px; color: #666; text-decoration: none; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="container">
        <h2>SÄ±nav BaÅŸvuru Formu</h2>
        
        <div id="examInfo" class="exam-summary">
            <p>SÄ±nav bilgileri yÃ¼kleniyor...</p>
        </div>

        <form id="basvuruForm" onsubmit="basvuruyuTamamla(event)">
            <div class="form-group">
                <label>AdÄ±nÄ±z</label>
                <input type="text" id="firstName" required placeholder="Ã–rn: Ahmet">
            </div>
            <div class="form-group">
                <label>SoyadÄ±nÄ±z</label>
                <input type="text" id="lastName" required placeholder="Ã–rn: YÄ±lmaz">
            </div>
            <div class="form-group">
                <label>TC Kimlik No</label>
                <input type="text" id="identityNumber" required maxlength="11" placeholder="11 haneli TC no">
            </div>
            <div class="form-group">
                <label>Telefon</label>
                <input type="tel" id="phone" required placeholder="0555 555 55 55">
            </div>>
            <div class="form-group">
                <label >Pasaport NumarasÄ± <small style="font-size: small; color: #b71c1c;">(Ã–SD SÄ±navlarÄ± iÃ§in zorunlu alan)</small></label>
                <input type="text" id="pass" required placeholder="U55555555"> 
            </div>
            <div class="form-group">
                <label>E-Mail</label>
                <input type="email" id="email" required placeholder="ornek@mail.com">
            </div>
            <div class="form-group">
                <label>Adres</label>
                <textarea id="address" required placeholder="AÃ§Ä±k adresiniz..."></textarea>
            </div>

            <button type="submit" id="submitBtn">Ã–deme ve KayÄ±t</button>
        </form>
        
        <a href="/" class="back-link">â† Listeye Geri DÃ¶n</a>
    </div>

    <script>
        // URL'den ID'yi al (Ã–rn: basvuru.html?id=65a4b...)
        const params = new URLSearchParams(window.location.search);
        const examId = params.get('id');
        let currentExam = null;

        // 1. Sayfa aÃ§Ä±lÄ±nca sÄ±nav bilgilerini Ã§ekip gÃ¶sterelim
        async function sinavBilgisiniGetir() {
            if(!examId) {
                alert("SÄ±nav seÃ§ilmedi!");
                window.location.href = "/";
                return;
            }

            // TÃ¼m sÄ±navlarÄ± Ã§ekip iÃ§inden doÄŸru olanÄ± buluyoruz (Basit yÃ¶ntem)
            // Normalde tekli Ã§ekim (/api/exams/:id) daha iyidir ama ÅŸimdilik bÃ¶yle yapalÄ±m
            const res = await fetch('/api/exams');
            const exams = await res.json();
            currentExam = exams.find(e => e._id === examId);

            if (currentExam) {
                document.getElementById('examInfo').innerHTML = `
                    <h3>${currentExam.title} (${currentExam.level})</h3>
                    <p>ğŸ“… Tarih: ${new Date(currentExam.date).toLocaleDateString()}</p>
                    <p>ğŸ“ Yer: ${currentExam.city}</p>
                    <p>ğŸ’° Tutar: <b>${currentExam.price} â‚¬</b></p>
                `;
            }
        }

        // 2. Form GÃ¶nderilince (Submit)
        async function basvuruyuTamamla(e) {
            e.preventDefault(); // Sayfa yenilenmesini engelle
            
            const btn = document.getElementById('submitBtn');
            btn.textContent = "Ä°ÅŸleniyor...";
            btn.disabled = true;

            const formData = {
                examId: examId,
                candidate: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    identityNumber: document.getElementById('identityNumber').value,
                    phone: document.getElementById('phone').value,
                    pass: document.getElementById('pass').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value
                }
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert("âœ… BaÅŸvuru BaÅŸarÄ±lÄ±! KaydÄ±nÄ±z alÄ±ndÄ±.");
                    window.location.href = "/"; // Ana sayfaya dÃ¶n
                } else {
                    alert("Hata: " + result.message);
                    btn.disabled = false;
                    btn.textContent = "Ã–deme ve KayÄ±t";
                }

            } catch (error) {
                console.error(error);
                alert("Bir hata oluÅŸtu.");
            }
        }

        sinavBilgisiniGetir();
    </script>
</body>
</html>